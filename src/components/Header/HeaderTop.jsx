import React, { useState, useEffect } from 'react'
import link_img from '../../img/link_img'

import { useFetchSteamLoginUrlMutation } from '../../redux/cases/cases';
import { Link } from 'react-router-dom';

export const HeaderTop = ({ refetchUserData, error, userData, setLogin, login, isMuted, setMuted, isLoading }) => {

  // REGISTER STEAM
  const isAuth = document.cookie?.split('; ').find(row => row?.startsWith('access_token='));
  useEffect(() => {
      setTimeout(() => {
          refetchUserData(); 
      }, 500);
  }, [isAuth]);
  
  useEffect(() => {
    localStorage.setItem('muted', isMuted);
  }, [isMuted]);

  if (error?.data?.error) {
    document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
  }

  const [fetchSteamLoginUrl] = useFetchSteamLoginUrlMutation();
  const [steamLoginErr, setSteamLoginErr] = useState();
  
  const handleSteamLogin = async () => {
      try {
          const { data } = await fetchSteamLoginUrl({ type: "steam" });
          window.location.href = data.data.redirect_url;

          setLogin(false);
      } catch (error) {
          setSteamLoginErr('Неудалось получить ссылку')
      }
  };

  useEffect(() => {
    if (login === true) {
      handleSteamLogin();
      console.log('login to steam');
    }
  }, [login]);

  return (
    <div className='HeaderTop'>
      <div className='inner'>
        <div className='HeaderLeftLine'>
          <svg xmlns="http://www.w3.org/2000/svg" width="897" height="65" viewBox="0 0 897 65" fill="none">
            <path d="M892.355 -625H896.632L411.429 65.2595H407.152L892.355 -625Z" fill="#DF6D03"/>
            <path d="M877.813 -625H882.09L396.887 65.2595H392.61L877.813 -625Z" fill="#DF6D03"/>
            <path d="M863.273 -625H867.55L382.346 65.2595H378.069L863.273 -625Z" fill="#DF6D03"/>
            <path d="M848.731 -625H853.008L367.805 65.2595H363.528L848.731 -625Z" fill="#DF6D03"/>
            <path d="M834.19 -625H838.468L353.264 65.2595H348.987L834.19 -625Z" fill="#DF6D03"/>
            <path d="M819.649 -625H823.926L338.723 65.2595H334.447L819.649 -625Z" fill="#DF6D03"/>
            <path d="M805.108 -625H809.385L324.181 65.2595H319.906L805.108 -625Z" fill="#DF6D03"/>
            <path d="M790.567 -625H794.844L309.64 65.2595H305.364L790.567 -625Z" fill="#DF6D03"/>
            <path d="M776.026 -625H780.302L295.099 65.2595H290.823L776.026 -625Z" fill="#DF6D03"/>
            <path d="M761.485 -625H765.761L280.559 65.2595H276.282L761.485 -625Z" fill="#DF6D03"/>
            <path d="M746.944 -625H751.22L266.017 65.2595H261.74L746.944 -625Z" fill="#DF6D03"/>
            <path d="M732.403 -625H736.679L251.476 65.2595H247.199L732.403 -625Z" fill="#DF6D03"/>
            <path d="M717.862 -625H722.138L236.935 65.2595H232.658L717.862 -625Z" fill="#DF6D03"/>
            <path d="M703.32 -625H707.597L222.394 65.2595H218.117L703.32 -625Z" fill="#DF6D03"/>
            <path d="M688.779 -625H693.056L207.853 65.2595H203.576L688.779 -625Z" fill="#DF6D03"/>
            <path d="M674.238 -625H678.515L193.312 65.2595H189.035L674.238 -625Z" fill="#DF6D03"/>
            <path d="M659.697 -625H663.974L178.77 65.2595H174.493L659.697 -625Z" fill="#DF6D03"/>
            <path d="M645.156 -625H649.433L164.229 65.2595H159.952L645.156 -625Z" fill="#DF6D03"/>
            <path d="M630.614 -625H634.891L149.688 65.2595H145.411L630.614 -625Z" fill="#DF6D03"/>
            <path d="M616.073 -625H620.35L135.147 65.2595H130.87L616.073 -625Z" fill="#DF6D03"/>
            <path d="M601.532 -625H605.809L120.606 65.2595H116.329L601.532 -625Z" fill="#DF6D03"/>
            <path d="M586.991 -625H591.268L106.065 65.2595H101.788L586.991 -625Z" fill="#DF6D03"/>
            <path d="M572.45 -625H576.727L91.5234 65.2595H87.2471L572.45 -625Z" fill="#DF6D03"/>
            <path d="M557.909 -625H562.186L76.9821 65.2595H72.7064L557.909 -625Z" fill="#DF6D03"/>
            <path d="M543.368 -625H547.645L62.4409 65.2595H58.1645L543.368 -625Z" fill="#DF6D03"/>
            <path d="M528.827 -625H533.104L47.8995 65.2595H43.6238L528.827 -625Z" fill="#DF6D03"/>
            <path d="M514.285 -625H518.562L33.3592 65.2595H29.0822L514.285 -625Z" fill="#DF6D03"/>
            <path d="M499.744 -625H504.021L18.8183 65.2595H14.5413L499.744 -625Z" fill="#DF6D03"/>
            <path d="M485.203 -625H489.48L4.27702 65.2595H0L485.203 -625Z" fill="#DF6D03"/>
          </svg>
        </div>
        <div className='HeaderCenterLine'>
          <svg xmlns="http://www.w3.org/2000/svg" width="839" height="65" viewBox="0 0 839 65" fill="none">
            <path opacity="0.6" fillRule="evenodd" clipRule="evenodd" d="M2.38308 64.9999H0L496.635 -641H499.029L2.38308 64.9999ZM10.4834 64.9999H8.10027L504.736 -641H507.119L10.4834 64.9999ZM18.5627 64.9999H16.1901L512.826 -641H515.219L18.5627 64.9999ZM26.6734 64.9999H24.2904L520.926 -641H523.309L26.6734 64.9999ZM34.7528 64.9999H32.3802L529.016 -641H531.409L34.7528 64.9999ZM42.8635 64.9999H40.4804L537.116 -641H539.499L42.8635 64.9999ZM50.9429 64.9999H48.5702L545.206 -641H547.589L50.9429 64.9999ZM59.0536 64.9999H56.6705L553.306 -641H555.689L59.0536 64.9999ZM67.1329 64.9999H64.7603L561.396 -641H563.779L67.1329 64.9999ZM75.2437 64.9999H72.8501L569.496 -641H571.879L75.2437 64.9999ZM83.323 64.9999H80.9504L577.586 -641H579.958L83.323 64.9999ZM91.4338 64.9999H89.0402L585.686 -641H588.069L91.4338 64.9999ZM99.5131 64.9999H97.1405L593.776 -641H596.149L99.5131 64.9999ZM107.613 64.9999H105.23L601.876 -641H604.259L107.613 64.9999ZM115.703 64.9999H113.331L609.966 -641H612.339L115.703 64.9999ZM123.803 64.9999H121.42L618.067 -641H620.45L123.803 64.9999ZM131.893 64.9999H129.521L626.156 -641H628.529L131.893 64.9999ZM139.994 64.9999H137.61L634.257 -641H636.64L139.994 64.9999ZM148.083 64.9999H145.711L642.346 -641H644.719L148.083 64.9999ZM156.173 64.9999H153.79L650.447 -641H652.83L156.173 64.9999ZM164.273 64.9999H161.901L658.536 -641H660.909L164.273 64.9999ZM172.363 64.9999H169.98L666.637 -641H669.009L172.363 64.9999ZM180.464 64.9999H178.091L674.727 -641H677.099L180.464 64.9999ZM188.553 64.9999H186.171L682.827 -641H685.199L188.553 64.9999ZM196.654 64.9999H194.281L690.917 -641H693.289L196.654 64.9999ZM204.743 64.9999H202.361L699.017 -641H701.39L204.743 64.9999ZM212.844 64.9999H210.471L707.107 -641H709.479L212.844 64.9999ZM220.933 64.9999H218.551L715.207 -641H717.58L220.933 64.9999ZM229.034 64.9999H226.661L723.297 -641H725.669L229.034 64.9999ZM237.124 64.9999H234.741L731.397 -641H733.77L237.124 64.9999ZM245.224 64.9999H242.841L739.487 -641H741.859L245.224 64.9999ZM253.314 64.9999H250.931L747.566 -641H749.96L253.314 64.9999ZM261.414 64.9999H259.031L755.677 -641H758.05L261.414 64.9999ZM269.504 64.9999H267.121L763.756 -641H766.15L269.504 64.9999ZM277.604 64.9999H275.221L771.867 -641H774.24L277.604 64.9999ZM285.694 64.9999H283.311L779.946 -641H782.34L285.694 64.9999ZM293.794 64.9999H291.411L788.057 -641H790.43L293.794 64.9999ZM301.884 64.9999H299.501L796.137 -641H798.53L301.884 64.9999ZM309.984 64.9999H307.601L804.237 -641H806.62L309.984 64.9999ZM318.074 64.9999H315.691L812.327 -641H814.72L318.074 64.9999ZM326.174 64.9999H323.791L820.427 -641H822.81L326.174 64.9999ZM334.264 64.9999H331.881L828.517 -641H830.9L334.264 64.9999ZM342.365 64.9999H339.982L836.617 -641H839L342.365 64.9999Z" fill="url(#paint0_linear_1_404)"/>
            <defs>
              <linearGradient id="paint0_linear_1_404" x1="-747.5" y1="-332.5" x2="1254" y2="452" gradientUnits="userSpaceOnUse">
                <stop offset="0.554901" stopColor="#A7510D"/>
                <stop offset="0.894095" stopColor="#180838"/>
              </linearGradient>
            </defs>
          </svg>
        </div>
        <div className='HeaderRightLine'>
          <svg xmlns="http://www.w3.org/2000/svg" width="277" height="65" viewBox="0 0 277 65" fill="none">
            <path opacity="0.6" fillRule="evenodd" clipRule="evenodd" d="M2.38308 64.9999H0L496.635 -641H499.029L2.38308 64.9999ZM10.4834 64.9999H8.10027L504.736 -641H507.119L10.4834 64.9999ZM18.5627 64.9999H16.1901L512.826 -641H515.219L18.5627 64.9999ZM26.6734 64.9999H24.2904L520.926 -641H523.309L26.6734 64.9999ZM34.7528 64.9999H32.3802L529.016 -641H531.409L34.7528 64.9999ZM42.8635 64.9999H40.4804L537.116 -641H539.499L42.8635 64.9999ZM50.9429 64.9999H48.5702L545.206 -641H547.589L50.9429 64.9999ZM59.0536 64.9999H56.6705L553.306 -641H555.689L59.0536 64.9999ZM67.1329 64.9999H64.7603L561.396 -641H563.779L67.1329 64.9999ZM75.2437 64.9999H72.8501L569.496 -641H571.879L75.2437 64.9999ZM83.323 64.9999H80.9504L577.586 -641H579.958L83.323 64.9999ZM91.4338 64.9999H89.0402L585.686 -641H588.069L91.4338 64.9999ZM99.5131 64.9999H97.1405L593.776 -641H596.149L99.5131 64.9999ZM107.613 64.9999H105.23L601.876 -641H604.259L107.613 64.9999ZM115.703 64.9999H113.331L609.966 -641H612.339L115.703 64.9999ZM123.803 64.9999H121.42L618.067 -641H620.45L123.803 64.9999ZM131.893 64.9999H129.521L626.156 -641H628.529L131.893 64.9999ZM139.994 64.9999H137.61L634.257 -641H636.64L139.994 64.9999ZM148.083 64.9999H145.711L642.346 -641H644.719L148.083 64.9999ZM156.173 64.9999H153.79L650.447 -641H652.83L156.173 64.9999ZM164.273 64.9999H161.901L658.536 -641H660.909L164.273 64.9999ZM172.363 64.9999H169.98L666.637 -641H669.009L172.363 64.9999ZM180.464 64.9999H178.091L674.727 -641H677.099L180.464 64.9999ZM188.553 64.9999H186.171L682.827 -641H685.199L188.553 64.9999ZM196.654 64.9999H194.281L690.917 -641H693.289L196.654 64.9999ZM204.743 64.9999H202.361L699.017 -641H701.39L204.743 64.9999ZM212.844 64.9999H210.471L707.107 -641H709.479L212.844 64.9999ZM220.933 64.9999H218.551L715.207 -641H717.58L220.933 64.9999ZM229.034 64.9999H226.661L723.297 -641H725.669L229.034 64.9999ZM237.124 64.9999H234.741L731.397 -641H733.77L237.124 64.9999ZM245.224 64.9999H242.841L739.487 -641H741.859L245.224 64.9999ZM253.314 64.9999H250.931L747.566 -641H749.96L253.314 64.9999ZM261.414 64.9999H259.031L755.677 -641H758.05L261.414 64.9999ZM269.504 64.9999H267.121L763.756 -641H766.15L269.504 64.9999ZM277.604 64.9999H275.221L771.867 -641H774.24L277.604 64.9999ZM285.694 64.9999H283.311L779.946 -641H782.34L285.694 64.9999ZM293.794 64.9999H291.411L788.057 -641H790.43L293.794 64.9999ZM301.884 64.9999H299.501L796.137 -641H798.53L301.884 64.9999ZM309.984 64.9999H307.601L804.237 -641H806.62L309.984 64.9999ZM318.074 64.9999H315.691L812.327 -641H814.72L318.074 64.9999ZM326.175 64.9999H323.791L820.427 -641H822.81L326.175 64.9999ZM334.264 64.9999H331.881L828.517 -641H830.9L334.264 64.9999ZM342.365 64.9999H339.982L836.617 -641H839L342.365 64.9999Z" fill="black"/>
          </svg>
        </div>

        <div className='wrapper'>
          {isLoading ? (
            <button className='replenishBtn balance loadingBtn'>
              <span>
                <img src={link_img.replenishSvg} alt='' />
              </span>
              загрузка
            </button>
          ) : (
            !isAuth || userData?.balance === "0.00" ? (
              <button className='replenishBtn'>
                <span>
                  <img src={link_img.replenishSvg} alt='' />
                </span>
                пополнить
              </button>
            ) : (
              <>
                <button className='replenishBtn'>
                  <span>
                    <img src={link_img.replenishSvg} alt='' />
                  </span>
                  пополнить
                </button>
                <button className='replenishBtn balance'>
                  <span>
                    <img src={link_img.replenishSvg} alt='' />
                  </span>
                  {userData?.balance} руб.
                </button>
              </>
            )
          )}

          <div className='buttonsRight'>
            {isAuth ? (
              isLoading ? (
                <div className='AvatarLoading'>
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M11.9648 13.4769C15.5191 13.4769 18.3695 10.4492 18.3695 6.75692C18.3695 3.06462 15.5191 0 11.9648 0C8.41056 0 5.56012 3.02769 5.56012 6.72C5.56012 10.4123 8.41056 13.4769 11.9648 13.4769ZM11.9648 1.77231C14.5689 1.77231 16.6804 3.98769 16.6804 6.72C16.6804 9.45231 14.5689 11.6677 11.9648 11.6677C9.3607 11.6677 7.24927 9.48923 7.24927 6.75692C7.24927 4.02462 9.3607 1.77231 11.9648 1.77231ZM0.844575 24H23.1554C23.6129 24 24 23.5938 24 23.1138C24 18.4615 20.3754 14.6585 15.9414 14.6585H8.05865C3.62463 14.6585 0 18.4615 0 23.1138C0 23.5938 0.387097 24 0.844575 24ZM8.05865 16.4308H15.9414C19.1789 16.4308 21.8182 18.9415 22.2405 22.2277H1.75953C2.18182 18.9415 4.82111 16.4308 8.05865 16.4308Z" fill="#4E127D"/>
                  </svg>
                </div>
              ) : (
                <Link to="/profile" className='ProfileImg'>
                  <img src={userData?.avatar_img} alt=''/>
                </Link>
              )
            ) 
            : (
              <button className='loginBtn' onClick={handleSteamLogin}>
                <span>
                  <img src={link_img.steamSvg} alt='' />
                </span>
                войти
              </button>
            )}

            <button className='sound' onClick={() => setMuted(!isMuted)}>
              {isMuted ? (
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="17" viewBox="0 0 22 17" fill="none">
                  <path d="M9.23948 0.302748L5.41659 4.12478H1.03124C0.46148 4.12478 0 4.58626 0 5.15602V11.3435C0 11.9128 0.46148 12.3747 1.03124 12.3747H5.41659L9.23948 16.1967C9.88529 16.8425 10.9999 16.3888 10.9999 15.4676V1.03192C10.9999 0.10982 9.88443 -0.342206 9.23948 0.302748ZM19.8359 8.24974L21.797 6.28867C22.0677 6.01797 22.0677 5.57883 21.797 5.30813L20.8164 4.32759C20.5457 4.05689 20.1066 4.05689 19.8359 4.32759L17.8748 6.28867L15.9137 4.32759C15.643 4.05689 15.2039 4.05689 14.9332 4.32759L13.9527 5.30813C13.682 5.57883 13.682 6.01797 13.9527 6.28867L15.9137 8.24974L13.9531 10.2104C13.6824 10.4811 13.6824 10.9202 13.9531 11.1909L14.9336 12.1715C15.2043 12.4422 15.6435 12.4422 15.9142 12.1715L17.8748 10.2108L19.8359 12.1719C20.1066 12.4426 20.5457 12.4426 20.8164 12.1719L21.797 11.1914C22.0677 10.9207 22.0677 10.4815 21.797 10.2108L19.8359 8.24974Z" fill="white"/>
                </svg>
              ) : (
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="21" viewBox="0 0 25 21" fill="none">
                 <path d="M9.3329 2.40853L5.47135 6.29991H1.04167C0.466146 6.29991 0 6.76976 0 7.34986V13.6496C0 14.2292 0.466146 14.6995 1.04167 14.6995H5.47135L9.3329 18.5909C9.98524 19.2484 11.1111 18.7864 11.1111 17.8485V3.15093C11.1111 2.2121 9.98437 1.75187 9.3329 2.40853ZM19.4596 0.173882C18.9748 -0.14679 18.3233 -0.0116092 18.0052 0.47793C17.6866 0.966595 17.822 1.62325 18.3069 1.94392C21.1832 3.84652 22.8997 7.04493 22.8997 10.5001C22.8997 13.9554 21.1832 17.1538 18.3069 19.0564C17.822 19.3766 17.6866 20.0337 18.0052 20.5219C18.3108 20.9905 18.957 21.1589 19.4596 20.826C22.9284 18.531 25 14.6702 25 10.4997C25 6.32922 22.9284 2.4689 19.4596 0.173882ZM20.8333 10.4997C20.8333 7.7204 19.4418 5.16508 17.1107 3.66453C16.625 3.35217 15.9809 3.49741 15.6732 3.99089C15.3655 4.48437 15.5091 5.13752 15.9948 5.45032C17.7201 6.56108 18.75 8.44837 18.75 10.4997C18.75 12.5511 17.7201 14.4383 15.9948 15.5491C15.5091 15.8615 15.3655 16.5146 15.6732 17.0085C15.9557 17.4618 16.5898 17.6709 17.1107 17.3349C19.4418 15.8343 20.8333 13.2795 20.8333 10.4997ZM14.6801 7.13681C14.1775 6.85988 13.5434 7.04231 13.2648 7.55022C12.9874 8.05814 13.171 8.69642 13.6749 8.97684C14.2352 9.28702 14.5833 9.87105 14.5833 10.4997C14.5833 11.1288 14.2352 11.7124 13.6753 12.0226C13.1714 12.303 12.9878 12.9413 13.2652 13.4492C13.5443 13.9593 14.1788 14.1404 14.6806 13.8626C15.9058 13.1823 16.6671 11.894 16.6671 10.4993C16.6671 9.10459 15.9058 7.81665 14.6801 7.13681Z" fill="white"/>
                </svg>
              )}
            </button>
          </div>

        </div>
      </div>
    </div>
  )
}
